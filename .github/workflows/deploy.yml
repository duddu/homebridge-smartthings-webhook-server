name: Deploy on Northflank

run-name: ${{ github.event.client_payload.deploy_run_name }}

on:
  repository_dispatch:
    types: [ deploy-northflank ]

concurrency:
  group: deploy-northflank

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env:
      VERSION_URL: https://${{ vars.NORTHFLANK_CUSTOM_DOMAIN }}/version
    environment:
      name: duddu.dev
      url: ${{ env.VERSION_URL }}
    steps:
      - name: Invoke Northflank webhook
        timeout-minutes: 1
        run: curl -fs ${{ secrets.NORTHFLANK_WEBHOOK_URL }} >/dev/null
      - name: Verify deployed version
        timeout-minutes: 5
        run: |
          while curl -fs ${{ env.VERSION_URL }} | grep "${{ github.event.client_payload.deploy_revision }}" &>/dev/null; [[ $? -ne 0 ]];
          do
            echo "Waiting for deployment..."
            sleep 10
          done
          echo
          echo "Version healthcheck succeded! Deployed revision: ${{ github.event.client_payload.deploy_revision }}"